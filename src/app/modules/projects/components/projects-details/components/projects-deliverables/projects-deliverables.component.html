<!-- analytics widgets -->
<h3 class="form-title mb-3">{{ "projects.deliverablesStatus" | translate }}</h3>
<div class="analytics-widgets mb-4">
  <div class="analytics-widgets-items">
    <app-stats-widget
      [id]="1"
      [count]="delievrablesStats?.accepted"
      [title]="'projects.accepted' | translate"
      [icon]="'bx bx-check-circle'"
      [type]="'success'"
    ></app-stats-widget>
    <app-stats-widget
      [id]="2"
      [count]="delievrablesStats?.pending"
      [title]="'projects.pending' | translate"
      [icon]="'bx bx-minus-circle'"
      [type]="'warning'"
    ></app-stats-widget>
    <app-stats-widget
      [id]="3"
      [count]="delievrablesStats?.rejected"
      [title]="'projects.rejected' | translate"
      [icon]="'bx bx-x-circle'"
      [type]="'danger'"
    ></app-stats-widget>
    <app-stats-widget
      [id]="4"
      [count]="delievrablesStats?.submitted"
      [title]="'projects.submitted' | translate"
      [icon]="'bx bx-check-double'"
      [type]="'primary'"
    ></app-stats-widget>
  </div>
</div>

<!-- filters -->
<div class="deliverables-filters d-flex align-items-center gap-3 mb-4">
  <app-select
    #phaseSelect
    class="milestone-select"
    [placeholder]="'shared.phase' | translate"
    [items]="milestonesList"
    [bindVlaue]="'id'"
    [bindLabel]="lang == 'ar' ? 'nameAr' : 'name'"
    [clearable]="true"
    [value]="defaultMileStone"
    (change)="onMilestoneSortChange($event)"
  ></app-select>

  <app-select
    class="status-select mr-auto"
    [placeholder]="'shared.status' | translate"
    [items]="deliverableStatusList"
    [bindVlaue]="'name'"
    [bindLabel]="lang == 'ar' ? 'nameAr' : 'name'"
    [clearable]="true"
    (change)="onStatusSortChange($event)"
  ></app-select>

  <div class="search-bar-container">
    <input
      type="text"
      #input
      [(ngModel)]="query"
      [placeholder]="'projects.searchDeliverables' | translate"
    />
    <i class="bx bx-search"></i>
  </div>
</div>

<!-- deliverables list -->
<h3 class="form-title mb-3">{{ "projects.deliverablesList" | translate }}</h3>
<div class="row gx-4">
  <div class="col-4">
    <div class="deliverables-cards-container">
      <div
        *ngFor="let item of deliverables | search : query; let i = index"
        class="deliverable-card"
        (click)="selectedDeliverable = i"
        [class.active]="i === selectedDeliverable"
      >
        <div class="header">
          <h4>{{ item.title[lang] }}</h4>

          <app-badge
            *ngIf="item?.status === 'Accepted'"
            [className]="'complete'"
            [label]="'projects.accepted' | translate"
          ></app-badge>
          <app-badge
            *ngIf="item?.status === 'Pending'"
            [className]="'inProgress'"
            [label]="'projects.pending' | translate"
          ></app-badge>
          <app-badge
            *ngIf="item?.status === 'Rejected'"
            [className]="'rejected'"
            [label]="'projects.rejected' | translate"
          ></app-badge>
          <app-badge
            *ngIf="item?.status === 'Submitted'"
            [className]="'started'"
            [label]="'projects.submitted' | translate"
          ></app-badge>
        </div>

        <div class="footer">
          <span class="description">{{ item?.milestoneName[lang] }}</span>
          <span class="date">
            {{
              lang === "en"
                ? ((item?.dueDate | uTCToLocalDate) | date : "dd/MM/yyyy")
                : ((item?.dueDate | uTCToLocalDate) | localizeDate : "dd/MM/yyyy")
            }}
          </span>
        </div>
      </div>

      <app-empty-state
        *ngIf="(deliverables | search : query)?.length === 0"
        class="d-block my-4"
        [title]="'projects.noDeliverablesMsg' | translate"
      ></app-empty-state>
    </div>
  </div>

  <div class="col-8">
    <div class="deliverable-details-card" *ngIf="deliverables">
      <div class="header">
        <div class="first-col">
          <h2>{{ deliverables[selectedDeliverable]?.title[lang] }}</h2>
          <div>
            <span class="description">
              {{ deliverables[selectedDeliverable]?.milestoneName[lang] }}
            </span>
            <div class="separator"></div>
            <div class="date">
              <i class="bx bx-calendar"></i>
              <span>
                {{ (deliverables[selectedDeliverable]?.dueDate | uTCToLocalDate) | date : "dd/MM/yyyy hh:mm a" }}
              </span>
            </div>
          </div>
        </div>
        <div class="second-col">
          <app-badge
            *ngIf="deliverables[selectedDeliverable]?.status === 'Accepted'"
            [className]="'complete'"
            [label]="'projects.accepted' | translate"
          ></app-badge>
          <app-badge
            *ngIf="deliverables[selectedDeliverable]?.status === 'Pending'"
            [className]="'inProgress'"
            [label]="'projects.pending' | translate"
          ></app-badge>
          <app-badge
            *ngIf="deliverables[selectedDeliverable]?.status === 'Rejected'"
            [className]="'rejected'"
            [label]="'projects.rejected' | translate"
          ></app-badge>
          <app-badge
            *ngIf="deliverables[selectedDeliverable]?.status === 'Submitted'"
            [className]="'started'"
            [label]="'projects.submitted' | translate"
          ></app-badge>
        </div>
      </div>
      <div class="body">
        <ul
          class="comments-list mb-4"
          *ngIf="deliverables[selectedDeliverable]?.actions?.length !== 0"
        >
          <li
            *ngFor="let action of deliverables[selectedDeliverable]?.actions"
            class="comment"
          >
            <div class="comment-header">
              <div class="profile">
                <!-- <img
                  *ngIf="action?.takenBy?.profileImage"
                  [src]="action?.takenBy?.profileImage"
                  alt=""
                /> -->
                <app-initials
                  [dimensions]="{ height: 48, width: 48 }"
                  [name]="action?.takenBy?.name.en"
                ></app-initials>
                <div class="details">
                  <span class="name">{{ action?.takenBy?.name[lang] }}</span>
                  <span class="position" *ngIf="action?.takenBy?.position">
                    {{ action?.takenBy?.position | translate }}
                  </span>
                  <span class="date">
                    {{ (action?.createdDate | uTCToLocalDate) | date : "dd/MM/yyyy hh:mm a" }}
                  </span>
                </div>
              </div>

              <app-badge
                *ngIf="action?.action === 'Accepted'"
                [className]="'complete'"
                [label]="'projects.accepted' | translate"
              ></app-badge>
              <app-badge
                *ngIf="action?.action === 'Pending'"
                [className]="'inProgress'"
                [label]="'projects.pending' | translate"
              ></app-badge>
              <app-badge
                *ngIf="action?.action === 'Rejected'"
                [className]="'rejected'"
                [label]="'projects.rejected' | translate"
              ></app-badge>
              <app-badge
                *ngIf="action?.action === 'Submitted'"
                [className]="'started'"
                [label]="'projects.submitted' | translate"
              ></app-badge>
            </div>
            <div class="comment-body">
              <p class="mb-0">{{ action?.comment }}</p>
            </div>
            <ul
              class="comment-attachments"
              *ngIf="action?.attachments?.length !== 0"
            >
              <li *ngFor="let doc of action?.attachments">
                <i class="bx bx-file"></i>
                <a (click)="openFile(doc?.fileName)" target="_blank">
                  {{ doc?.uploadedFileName }}
                </a>
              </li>
            </ul>
          </li>
        </ul>

        <div
          class="comments-empty-state mt-4"
          *ngIf="deliverables[selectedDeliverable]?.actions?.length === 0"
        >
          <app-empty-state
            [title]="'projects.noCommentsYet' | translate"
          ></app-empty-state>
        </div>

        <div
          class="row m-0"
          *ngIf="
            deliverables[selectedDeliverable]?.status !== 'Accepted' &&
            ((projectData?.hasPMPrivilege && deliverables[selectedDeliverable]?.status !== 'Submitted') || isPmo)
          "
        >
          <div
            class="comment-input-container row m-0"
            *ngIf="!projectData?.isProjectClosed"
          >
            <div class="first-col">
              <app-initials
                [dimensions]="{ height: 48, width: 48 }"
                [name]="currentUserData.userName"
              ></app-initials>
              <!-- <img
                *ngIf="currentUserData?.userPicture?.url"
                [src]="currentUserData?.userPicture?.url"
                alt=""
              /> -->
              <!-- <div>
                <span class="name">{{ currentUserData.userName }}</span>
                <span class="position">{{ currentUserData.position }}</span>
              </div> -->
            </div>

            <div class="second-col">
              <textarea
                [formControl]="comment"
                [placeholder]="'projects.writeYourCommentHere' | translate"
              ></textarea>
            </div>

            <div class="third-col">
              <label class="action-file-input mr-2" for="action-file-input">
                <i class="bx bx-paperclip"></i>
                <input
                  (change)="onFilechange($event)"
                  id="action-file-input"
                  type="file"
                />
              </label>

              <button
                class="btn btn-main mr-2"
                *ngIf="deliverables[selectedDeliverable]?.status === 'Submitted' && isPmo"
                (click)="onAction('accept', deliverables[selectedDeliverable]?.id)"
              >
                {{ "shared.accept" | translate }}
              </button>

              <button
                class="btn btn-danger"
                *ngIf="deliverables[selectedDeliverable]?.status === 'Submitted' && isPmo"
                (click)="onAction('reject', deliverables[selectedDeliverable]?.id)"
              >
                {{ "shared.reject" | translate }}
              </button>

              <button
                class="btn btn-main"
                *ngIf="
                  deliverables[selectedDeliverable]?.status !== 'Submitted' &&
                  (projectData?.hasPMPrivilege || isPmo)
                "
                (click)="onAction('submit', deliverables[selectedDeliverable]?.id)"
              >
                {{ "shared.submit" | translate }}
              </button>
              <div class="d-flex align-items-center h-100"></div>
            </div>
          </div>

          <span
            *ngFor="let attachment of attachments; let i = index"
            class="uploaded-attachment"
          >
            <i class="bx bx-file"></i>
            {{ attachment?.title }}
            <i (click)="removeAttachment(i)" class="bx bx-x"></i>
          </span>
        </div>

        <div
          class="d-flex justify-content-end"
          *ngIf="
            deliverables[selectedDeliverable]?.status === 'Accepted'&& !projectData?.isProjectClosed && isPmo
          "
        >
          <button
            (click)="onAction('reopen', deliverables[selectedDeliverable]?.id)"
            class="btn btn-main"
          >
            {{ "projects.reopen" | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<app-confirm-modal
  [content]="'shared.confirmModalText' | translate"
  [btnContent]="'shared.confirm' | translate"
  [btnStyle]="'main'"
  (confirm)="onPopupConfirm(selectedAction, actionDeliverable)"
></app-confirm-modal>

<app-loading-modal
  [displayModal]="displayLoadingModal"
  [content]="'shared.actionInProgress' | translate"
></app-loading-modal>
